

<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>5. Software Architecture &#8212; Spawn of EnergyPlus</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootswatch-3.3.6/united/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap_custom.css" type="text/css" />
    <link rel="stylesheet" href="_static/custom.css" type="text/css" />
    <link rel="stylesheet" href="_static/custom-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.6/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="shortcut icon" href="_static/lbl-icon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="6. Numerical Methods of the Master Algorithm" href="numericalMethods.html" />
    <link rel="prev" title="4. Requirements" href="requirements.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default ">
    <div class="container-fluid">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html"><img src="_static/soep-logo.png">
           </a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="index.html">Index</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="preample.html">1. Preample</a><ul>
<li class="toctree-l2"><a class="reference internal" href="preample.html#purpose-of-the-document">1.1. Purpose of the Document</a></li>
<li class="toctree-l2"><a class="reference internal" href="preample.html#contributors">1.2. Contributors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="conventions.html">2. Conventions</a></li>
<li class="toctree-l1"><a class="reference internal" href="useCases.html">3. Use Cases</a><ul>
<li class="toctree-l2"><a class="reference internal" href="useCases.html#openstudio-integration">3.1. OpenStudio Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="useCases.html#measures">3.2. Measures</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">4. Requirements</a><ul>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#openstudio-integration">4.1. OpenStudio integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#mathematics">4.2. Mathematics</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#fmu-requirements">4.3. FMU Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#qss-implementation">4.4. QSS Implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="requirements.html#master-algorithm">4.5. Master Algorithm</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">5. Software Architecture</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#openstudio-integration">5.1. OpenStudio integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jmodelica-integration">5.2. JModelica Integration</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="numericalMethods.html">6. Numerical Methods of the Master Algorithm</a><ul>
<li class="toctree-l2"><a class="reference internal" href="numericalMethods.html#time-integration">6.1. Time Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="numericalMethods.html#algebraic-loops">6.2. Algebraic Loops</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">7. Application Programming Interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="api.html#generating-openstudio-models">7.1. Generating OpenStudio Models</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="benchmarks.html">8. Benchmarks</a></li>
<li class="toctree-l1"><a class="reference internal" href="acknowledgments.html">9. Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="zreferences.html">10. References</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">5. Software Architecture</a><ul>
<li><a class="reference internal" href="#openstudio-integration">5.1. OpenStudio integration</a><ul>
<li><a class="reference internal" href="#automated-documentation-ast-support-tool">5.1.1. Automated Documentation/AST Support Tool</a><ul>
<li><a class="reference internal" href="#background">5.1.1.1. Background</a></li>
<li><a class="reference internal" href="#proposed-workflow-process-and-toolchain">5.1.1.2. Proposed Workflow, Process, and Toolchain</a></li>
<li><a class="reference internal" href="#literature-review">5.1.1.3. Literature review</a></li>
<li><a class="reference internal" href="#discussion-and-details">5.1.1.4. Discussion and Details</a></li>
<li><a class="reference internal" href="#summary-of-questions-and-next-steps">5.1.1.5. Summary of Questions and Next Steps</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#jmodelica-integration">5.2. JModelica Integration</a><ul>
<li><a class="reference internal" href="#fmi-changes-for-qss">5.2.1. FMI Changes for QSS</a><ul>
<li><a class="reference internal" href="#event-handling">5.2.1.1. Event Handling</a><ul>
<li><a class="reference internal" href="#state-events">5.2.1.1.1. State Events</a></li>
<li><a class="reference internal" href="#event-indicators-that-depend-on-the-input">5.2.1.1.2. Event indicators that depend on the input</a></li>
<li><a class="reference internal" href="#workaround-for-implementing-event-indicators">5.2.1.1.3. Workaround for implementing event indicators</a></li>
<li><a class="reference internal" href="#time-events">5.2.1.1.4. Time Events</a></li>
</ul>
</li>
<li><a class="reference internal" href="#smoothtoken-for-qss">5.2.1.2. SmoothToken for QSS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#summary-of-proposed-changes">5.2.2. Summary of Proposed Changes</a></li>
<li><a class="reference internal" href="#open-topics">5.2.3. Open Topics</a><ul>
<li><a class="reference internal" href="#atomic-api">5.2.3.1. Atomic API</a></li>
<li><a class="reference internal" href="#xml-api">5.2.3.2. XML/API</a></li>
<li><a class="reference internal" href="#higher-derivatives">5.2.3.3. Higher Derivatives</a></li>
<li><a class="reference internal" href="#input-variables">5.2.3.4. Input Variables</a></li>
<li><a class="reference internal" href="#annotations">5.2.3.5. Annotations</a></li>
<li><a class="reference internal" href="#conditional-expressions-and-event-indicators">5.2.3.6. Conditional Expressions and Event Indicators</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="requirements.html" title="Previous Chapter: 4. Requirements"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 4. Requirements</span>
    </a>
  </li>
  <li>
    <a href="numericalMethods.html" title="Next Chapter: 6. Numerical Methods of the Master Algorithm"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">6. Numerical ... &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

<!--
          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
-->
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <div class="section" id="software-architecture">
<span id="sec-soft-arch"></span><h1>5. Software Architecture<a class="headerlink" href="#software-architecture" title="Permalink to this headline">¶</a></h1>
<div class="section" id="openstudio-integration">
<h2>5.1. OpenStudio integration<a class="headerlink" href="#openstudio-integration" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="#fig-overall-software-architecture"><span class="std std-numref">Fig. 5.1</span></a>
shows the overall software architecture of SOEP.</p>
<p>The <cite>Application</cite> on top of the figure may be an
equipment sales tool that uses an open, or a proprietary,
Modelica model library of their product line, which allows
a sales person to test and size equipment for a particular customer.</p>
<p>The <cite>HVAC Systems Editor</cite> allows drag and drop of components
from the <cite>Model Library</cite>,
similar to what can be done in today&#8217;s OS schematic editor.
In contrast, the <cite>Schematic Editor</cite> allows to freely place
and graphically connect Modelica components.
Once models have been manipulated in the
<cite>Schematic Editor</cite>, OS can only simulate them, but not apply
OS Measures to it, as models may have become incompatible
with the OS Measures. (This could in the future be changed
by parsing the AST of the model.)</p>
<p>In the <cite>Schematic Editor</cite>, user-provided Modelica libraries
can be loaded (for example, if a company has their own
control sequence library), manipulated and stored again
in the user-provided Modelica library. This functionality is also
needed for the OpenBuildingControl project.</p>
<p>Currently, the OpenStudio Model Library is compiled C++ code.
Our integration will generate a representation of the
Modelica library that allows OpenStudio to
dynamic load models for the SOEP mode.
Note that the JModelica distribution includes a C++ compiler.</p>
<div class="figure" id="id12">
<span id="fig-overall-software-architecture"></span><p class="plantuml">
<object data="_images/plantuml-5486606fbb23a0acfe9312301b4718ea77d3ed51.svg" type="image/svg+xml" style="width:1005px;height:747px;">
<img src="_images/plantuml-5486606fbb23a0acfe9312301b4718ea77d3ed51.png" alt="title Overall software architecture

scale max 1024 width

skinparam componentStyle uml2

package OpenStudio {
interface API
API - [Core]

package Legacy-Mode {
database &quot;Legacy\nModel Library&quot;
[Core] -&gt; [Legacy\nModel Library]: integrates
[Core] -&gt; [HVAC Systems Editor\n(Legacy Mode)]: integrates
[Core] -&gt; [EnergyPlus\nSimulator Interface]: integrates
}

package SOEP-Mode {
database &quot;SOEP\nModel Library&quot;
[Core] --&gt; [SOEP\nModel Library]: integrates
[Core] --&gt; [HVAC Systems Editor\n(SOEP Mode)]: integrates
[Core] --&gt; [SOEP\nSimulator Interface]: integrates
}
}

actor Developer as epdev
[Legacy\nModel Library] &lt;.. epdev : updates

package SOEP {
[HVAC Systems Editor\n(SOEP Mode)] ..&gt; [JModelica] : parses\nAST
[SOEP\nModel Library] &lt;.. [Conversion Script]: augments library\nby generating C++ code

[Conversion Script] .&gt; [JModelica]: parses\nAST
[SOEP\nSimulator Interface] .&gt; [JModelica] : writes inputs,\nruns simulation,\nreads outputs
database &quot;Modelica\nLibrary AST&quot; as mod_AST
[Conversion Script] -&gt; mod_AST: generates
database &quot;Modelica\nBuildings Library&quot;
[JModelica] -&gt; [Modelica\nBuildings Library]: imports
}

actor &quot;Developer or User&quot; as modev
[Conversion Script] &lt;.. modev : invokes

actor Developer as budev
[Modelica\nBuildings Library] &lt;.. budev : adds annotations

actor User as mouse
[User-Provided\nModelica Library] &lt;.. mouse : adds annotations


[Application] ..&gt; () API : uses
[Measures] ..&gt; () API : uses

database &quot;User-Provided\nModelica Library&quot;
[JModelica] --&gt; [User-Provided\nModelica Library]: imports

EnergyPlus &lt;.. [EnergyPlus\nSimulator Interface]: writes inputs,\nruns simulation,\nreads outputs

package EnergyPlus {
  [EnergyPlus.exe]
}

note left of mod_AST
  Used as an intermediate format and
  to verify incompatible changes.
end note

note bottom of [User-Provided\nModelica Library]
  Allows companies to use
  their own Modelica libraries
  with custom HVAC systems and
  control sequences, or
  to integrate an electronic
  equipment catalog or a
  library used for an equipment
  sales tool.
end note

note right of Application
  Application that uses
  the OpenStudio SDK.
end note" />

</object></p>
<p class="caption"><span class="caption-number">Fig. 5.1 </span>: Overall software architecture.<a class="headerlink" href="#id12" title="Permalink to this image">¶</a></p>
</div>
<div class="section" id="automated-documentation-ast-support-tool">
<h3>5.1.1. Automated Documentation/AST Support Tool<a class="headerlink" href="#automated-documentation-ast-support-tool" title="Permalink to this headline">¶</a></h3>
<p>This section describes an agreed-upon workflow, toolchain and process to
generate automated SOEP &#8220;documentation&#8221; and abstract syntax trees from Modelica
libraries; in particular, the Modelica Buildings Library (MBL).</p>
<p>The goal of this effort is to build a computer program that makes the <a class="reference external" href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">abstract
syntax tree (AST)</a> of the
Modelica Buildings Library (MBL) <a class="footnote-reference" href="#fn-mbl" id="id1">[1]</a> available to other tools via an XML
file. Specifically, this work should be of use to the OpenStudio team for
discovering available models and their parameters and other metadata for use
from the OpenStudio interface for SOEP.</p>
<div class="section" id="background">
<h4>5.1.1.1. Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h4>
<p>Modelica source code contains quite a lot of meta-data in addition to the
mathematical model itself. An annotation system exists within Modelica and
custom annotations can be written to pass data to tools. Annotations were
designed to be an extensible mechanism for capturing meta-data related to a
model including html-documentation, vendor-specific data, and graphical
annotations. Parameters, variables, equations, and models can contain
documentation strings and annotations. Furthermore, packages can be documented
and the display order of sub-packages, models, classes, functions, connectors
and other objects can be specified. Modelica libraries have a hierarchical
structure consisting mainly of packages which contain models and other objects
as well as sub-packages. Models themselves can be composed of multiple (possibly
replaceable) components. Much of this information will be required by the
OpenStudio tool in order to understand which component models are available,
where they reside in the library&#8217;s package structure (i.e., their fully
qualified name), what parameters they have, how they can be configured, how to
display them, and what other meta-data are available (such as documentation
strings and full-on HTML documentation).</p>
<p>This section is concerned about making the AST of Modelica source files,
including the metadata mentioned above, available to OpenStudio. We
will specifically focus on the Modelica Buildings Library (MBL), though as we
discuss later, the tool should also be able to work with other Modelica
packages and blocks.</p>
<p>The intent of the AST representation is <em>primarily</em> to be consumed by the
OpenStudio application for identification of models, model documentation, model
connecting points, inputs/outputs, and parameters and related meta-data.</p>
<p>Presumably, an OpenStudio application will consume some or all of the above
information, use it to provide an interface to the user, and ultimately write
out a Modelica file which connects the various library components, configures
various components and packages (for example, setting the &#8220;media&#8221; or working
fluid of fluid component models in various HVAC loops), and assigning
values to parameters.</p>
<p>To create models, information from other libraries, most notably, the Modelica
Standard Library (MSL) itself, may need to be made available. Typical
applications and examples from the MBL use
component models from both the MSL and MBL. There is also interest in being
able to support additional third party libraries over and above the MSL and
MBL. Therefore, it will be important that this tool is not limited to just
parsing/processing the MBL.</p>
<p>Also, related to meta-data, it has been proposed that the MBL add any
OpenStudio-specific metadata to the MBL files themselves. It was originally
envisioned that Modelica&#8217;s annotations should support just such a use-case.
It has been noted that if components from other libraries need to be made
available to OpenStudio, they could be pulled into the MBL and annotated
(for example, components from Modelica.Blocks).</p>
</div>
<div class="section" id="proposed-workflow-process-and-toolchain">
<h4>5.1.1.2. Proposed Workflow, Process, and Toolchain<a class="headerlink" href="#proposed-workflow-process-and-toolchain" title="Permalink to this headline">¶</a></h4>
<p>We propose to build a stand-alone batch-process program that will transform any
Modelica input file or library (specifically, the Modelica Buildings Library in
particular) into an XML document. The XML document will contain:</p>
<ul class="simple">
<li>identification of which models, classes, connectors, functions, etc. exist</li>
<li>identification of the relative hierarchy of the above components within the
package structure of the library</li>
<li><dl class="first docutils">
<dt>for each package, to know</dt>
<dd><ul class="first last">
<li>what models are available</li>
<li>what connection &#8220;ports&#8221; are available</li>
<li>for fluid ports, which ports carry the same fluid (so that media
assignments can be propagated through a circuit)</li>
<li>what control inputs/outputs are available</li>
<li>what parameters are available</li>
<li>what configuration management options exist (i.e., replaceable components
and packages and which parameters belong to which component)</li>
<li>including meta-data and attributes for all the above such as graphics
annotations, vendor annotations, html documentation, etc.</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Although we intend to build a stand-alone tool, there is interest from the
OpenStudio team in using this tool directly and/or incorporating the algorithms
into the OpenStudio interface to import new Modelica libraries and files. As
such, there are some upstream constraints such as a desire to minimize
dependencies. We will discuss this more below when we talk about programming
language.</p>
<p>We believe the <a class="reference external" href="http://www.jmodelica.org/api-docs/usersguide/JModelicaUsersGuide-1.17.0.pdf">JModelica</a>
tool suite will be able to provide the proper parsing tools for the AST we
need. Specifically, we must ensure that the AST we derive from JModelica meets
all of our needs &#8211; most notably, we must ensure we have access to all
annotations. Specifically, we are looking to JModelica for the following:</p>
<ol class="arabic simple">
<li>Provide programmatic access to the full AST of Modelica libraries</li>
<li>Provide that access through the Java and/or Python API.</li>
</ol>
<p>We have confirmed with preliminary work that we can walk a source AST of a
single Modelica file using the Python API of JModelica 1.17. We have also
determined that the AST information does include annotation data.
The OpenStudio team has expressed a preference for
using the Java API directly in hopes of reducing the dependencies required for
packaging. Therefore, we will use the Java API and develop a Java application
for accessing the AST parser.</p>
<p>The signature of the batch program we will write will be:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ast_doc_gen</span> <span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">out</span> <span class="o">&lt;</span><span class="n">outputfile</span><span class="o">-</span><span class="n">path</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">path_to_modelica_library</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Or looking at this as a data-flow diagram:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">modelica</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">filesystem</span> <span class="o">==&gt;</span> <span class="n">xml</span><span class="o">-</span><span class="n">file</span>
</pre></div>
</div>
<p>The <cite>ast_doc_gen</cite> tool will generate an XML file at <code class="docutils literal"><span class="pre">outputfile-path</span></code> based
on the library available at <code class="docutils literal"><span class="pre">path_to_modelica_library</span></code>. We propose that there
should only be one library documented per XML file. If additional library data
is generated, (for example, the MSL), each library should get its own file.</p>
<p>Options could include flags to allow turning off/on the reporting of various
constructs in the source library and for selecting only certain packages to
import. For example, the OpenStudio team may need to make the <cite>Modelica.Block</cite>
package of the MSL available for use with the MBL but would not necessarily
need to include other packages such as <cite>Modelica.Magnetic</cite>,
<cite>Modelica.Electrical</cite>, or <cite>Modelica.Mechanics</cite>.</p>
<p>An additional feature of the tool will be to perform a &#8220;diff&#8221; (i.e., logical
differences) between two generated XML files. The signature for this
application would be:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ast_doc_diff</span> <span class="o">&lt;</span><span class="n">options</span><span class="o">&gt;</span> <span class="o">--</span><span class="n">out</span> <span class="o">&lt;</span><span class="n">path_to_diff_report</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">path1</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">path2</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The data-flow diagram would be:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">path1</span><span class="p">,</span> <span class="n">path2</span><span class="p">)</span> <span class="o">==&gt;</span> <span class="n">xml</span><span class="o">-</span><span class="n">file</span>
</pre></div>
</div>
<p>The purpose of the <cite>ast_doc_diff</cite> tool would be to detect non-trivial
differences between two generated XML files that hold the AST of a Modelica
library and report those changes out to another XML file. The content of the
&#8220;difference&#8221; XML file would explicitly show the differences between the two
input manifests. The options here would allow for tweaking the meaning of what
it means to be &#8220;different&#8221;.</p>
<p>The following two lists attempt to list out examples of changes that
cannot be ignored as well as changes that can be ignored.</p>
<p><em>Significant Changes (Cannot be Ignored)</em></p>
<ul class="simple">
<li>changes to names of any public model/block, public parameters, variables,
connectors, or subcomponents</li>
<li>addition/subtraction of any public parameters, variables, connectors,
or subcomponents</li>
<li>addition/subtraction of packages/models/blocks/functions meant to be consumed
by OpenStudio</li>
<li>moving a model/block/function between packages (i.e., changing the path)</li>
</ul>
<p><em>Changes that may be Ignored</em></p>
<ul class="simple">
<li>changes in style without changes in meaning (addition or removal of
whitespace, windows newlines to linux newlines or vice versa, reordering
within a section)</li>
<li>changes to documentation strings</li>
<li>changes to text in embedded HTML documentation</li>
<li>changes to revision notes</li>
<li>changes to graphical annotations</li>
<li>changes in ordering of models/blocks/functions within a package</li>
<li>changes to <cite>protected</cite> sections of code</li>
<li>changes to <cite>equation</cite> or <cite>algorithm</cite> sections of code</li>
<li>changes to some models/blocks/functions may be completely ignored if, by
convention, we deem certain paths as &#8220;not directly consumable&#8221; by OpenStudio.
For example, we may wish to not consume paths under a <cite>BaseClasses</cite>,
<cite>Examples</cite>, or <cite>Functions</cite> designation.</li>
</ul>
<p>To summarize, the creation of or changes to the &#8220;public API&#8221; (public
parameters, variables, subcomponents, connectors) of models, blocks, or
functions must be compared for change detection. Documentation (HTML)/
documentation strings/graphics annotations will not affect the model interface
or semantics. Changes to protected properties or equations will not affect
the interface (but may affect the actual numeric output quantities).</p>
<p>Annotations could be used to signal status changes such as &#8220;deprecation&#8221;.</p>
<p>The <cite>ast_doc_diff</cite> tool would be of use in particular when new versions of the
MBL are released and the OpenStudio team would like to check if there are
non-trivial changes they need to integrate.</p>
</div>
<div class="section" id="literature-review">
<h4>5.1.1.3. Literature review<a class="headerlink" href="#literature-review" title="Permalink to this headline">¶</a></h4>
<p>There have been several attempts to represent or use XML in relation to
Modelica in the past (<a class="reference internal" href="zreferences.html#landin2014" id="id2">[Lan14]</a>, <a class="reference internal" href="zreferences.html#fritzson2003g" id="id3">[Fri03]</a>, <a class="reference internal" href="zreferences.html#pop2003" id="id4">[PF03]</a>, <a class="reference internal" href="zreferences.html#pop2005" id="id5">[PSAssmannF05]</a>, and <a class="reference internal" href="zreferences.html#reisenbichler2006" id="id6">[RKH+06]</a>).</p>
<p>In particular, N. Landin did work with Modelon using JModelica to export XML for
the purpose of model exchange <a class="reference internal" href="zreferences.html#landin2014" id="id7">[Lan14]</a> &#8211; this is very similar to our use case.
Unfortunately, this work deals only with &#8220;flattened&#8221; models &#8211; Modelica models
that have been instantiated with all of the hierarchy removed. For our use
case, the hierarchy must be preserved so that the OpenStudio team can
build a new model through instantiation of models from the MBL.</p>
<p>The paper by Reisenbichler 2006 motivates the usage of XML in association with
Modelica without getting into specifics <a class="reference internal" href="zreferences.html#reisenbichler2006" id="id8">[RKH+06]</a>. The remaining work by Pop and Fritzson
is thus the only comprehensive work on an XML representation of Modelica
<em>source</em> AST that appears in the literature (<a class="reference internal" href="zreferences.html#pop2003" id="id9">[PF03]</a>, <a class="reference internal" href="zreferences.html#pop2005" id="id10">[PSAssmannF05]</a>, and <a class="reference internal" href="zreferences.html#fritzson2003g" id="id11">[Fri03]</a>). The purpose of the XML work by Pop
and Fritzson was to create a complete XML representation of the entire Modelica
source. It is generally a good reference but we note that it is, perhaps
unnecessarily, verbose for our current needs. As such, although we will refer
to this work, we do not plan to duplicate it.</p>
</div>
<div class="section" id="discussion-and-details">
<h4>5.1.1.4. Discussion and Details<a class="headerlink" href="#discussion-and-details" title="Permalink to this headline">¶</a></h4>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">We are currently evaluating whether to use the commercial JModelica API
directly to do the following or whether to generate XML. We will
leave the discussion in as-is for now as it captures some elements
of the design work but it needs to be updated once a decision is made.</p>
</div>
<p>A key area of work will be on designing the data model of the XML output.
Specifically, we need to think through how to represent the models in the MBL
in such a way that they can be consumed by the <em>OpenStudio</em> toolchain. At the
planning meeting on February 1, 2017, it was discussed that we generally want
all of the information from the source AST <em>except</em> equation and algorithm
sections. All annotations should be made available.</p>
<p>One consideration will be: which version of the AST should be used to represent
packages, classes, models, etc. The <a class="reference external" href="http://www.jmodelica.org/api-docs/usersguide/JModelicaUsersGuide-1.17.0.pdf">JModelica User&#8217;s Guide 1.17</a>
in Chapter 9 talks about three kinds of AST: source level, instance level, and
flattened. The flattened AST is not relevant for us (it corresponds to a fully
flattened model instance ready to be compiled; our interest is in browsing all
objects for potential configuration).</p>
<p>The source level AST corresponds 1:1 to the original files in both structure
and content. Although the source AST is what we need, it does not expand out
components and extended classes and thus may require additional processing by
consumers.</p>
<p>An instance level AST, in contrast, represents the fully expanded instance of a
given model or class, including configurations. Although this is tempting to
use, we must remember that we are dealing with a library, not a model
<em>instance</em>. It will be <em>OpenStudio</em>&#8216;s job to build and specify a model class to
instantiate. Especially due to Modelica&#8217;s configuration mechanism, it would be
dangerous to treat object <em>classes</em> as <em>instances</em>.</p>
<p>Therefore, we delivered something closer to the source AST but
with a mind to construct the data model such that it is easy to trace
dependencies such as class extensions (i.e., inheritance) and replaceable
components.</p>
<p>For an example, consider the following model</p>
<div class="highlight-modelica"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">Buildings</span><span class="o">.</span><span class="n">Fluid</span><span class="o">.</span><span class="n">HeatExchangers</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">HeaterCooler_T</span>
  <span class="s2">&quot;Ideal heater or cooler with a prescribed outlet temperature&quot;</span>
  <span class="kr">extends</span> <span class="n">Buildings</span><span class="o">.</span><span class="n">Fluid</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">PartialTwoPortInterface</span><span class="p">;</span>
  <span class="kr">extends</span> <span class="n">Buildings</span><span class="o">.</span><span class="n">Fluid</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">TwoPortFlowResistanceParameters</span><span class="p">(</span>
    <span class="kr">final</span> <span class="n">computeFlowResistance</span><span class="o">=</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">dp_nominal</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Constants</span><span class="o">.</span><span class="n">eps</span><span class="p">));</span>
  <span class="kr">extends</span> <span class="n">Buildings</span><span class="o">.</span><span class="n">Fluid</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">PrescribedOutletStateParameters</span><span class="p">(</span>
    <span class="n">T_start</span><span class="o">=</span><span class="n">Medium</span><span class="o">.</span><span class="n">T_default</span><span class="p">);</span>

  <span class="kr">parameter</span> <span class="nb">Boolean</span> <span class="n">homotopyInitialization</span> <span class="o">=</span> <span class="kc">true</span> <span class="s2">&quot;= true, use homotopy method&quot;</span>
    <span class="kr">annotation</span><span class="p">(</span><span class="n">Evaluate</span><span class="o">=</span><span class="kc">true</span><span class="p">,</span> <span class="n">Dialog</span><span class="p">(</span><span class="n">tab</span><span class="o">=</span><span class="s2">&quot;Advanced&quot;</span><span class="p">));</span>

  <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealInput</span> <span class="n">TSet</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="n">displayUnit</span><span class="o">=</span><span class="s2">&quot;degC&quot;</span><span class="p">)</span>
    <span class="s2">&quot;Set point temperature of the fluid that leaves port_b&quot;</span>
    <span class="kr">annotation</span> <span class="p">(</span><span class="n">Placement</span><span class="p">(</span><span class="n">transformation</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">140</span><span class="p">,</span><span class="mi">40</span><span class="p">},{</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">80</span><span class="p">}})));</span>

  <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealOutput</span> <span class="n">Q_flow</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">)</span>
    <span class="s2">&quot;Heat added to the fluid (if flow is from port_a to port_b)&quot;</span>
    <span class="kr">annotation</span> <span class="p">(</span><span class="n">Placement</span><span class="p">(</span><span class="n">transformation</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="mi">100</span><span class="p">,</span><span class="mi">50</span><span class="p">},{</span><span class="mi">120</span><span class="p">,</span><span class="mi">70</span><span class="p">}})));</span>

<span class="kr">protected</span>
  <span class="n">Buildings</span><span class="o">.</span><span class="n">Fluid</span><span class="o">.</span><span class="n">FixedResistances</span><span class="o">.</span><span class="n">PressureDrop</span> <span class="n">preDro</span><span class="p">(</span>
    <span class="kr">redeclare</span> <span class="kr">final</span> <span class="kr">package</span> <span class="nc">Medium</span> <span class="o">=</span> <span class="n">Medium</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">m_flow_nominal</span><span class="o">=</span><span class="n">m_flow_nominal</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">deltaM</span><span class="o">=</span><span class="n">deltaM</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">allowFlowReversal</span><span class="o">=</span><span class="n">allowFlowReversal</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">show_T</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">from_dp</span><span class="o">=</span><span class="n">from_dp</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">linearized</span><span class="o">=</span><span class="n">linearizeFlowResistance</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">homotopyInitialization</span><span class="o">=</span><span class="n">homotopyInitialization</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">dp_nominal</span><span class="o">=</span><span class="n">dp_nominal</span><span class="p">)</span> <span class="s2">&quot;Flow resistance&quot;</span>
    <span class="kr">annotation</span> <span class="p">(</span><span class="n">Placement</span><span class="p">(</span><span class="n">transformation</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">},{</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">10</span><span class="p">}})));</span>

  <span class="n">Buildings</span><span class="o">.</span><span class="n">Fluid</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">PrescribedOutletState</span> <span class="n">heaCoo</span><span class="p">(</span>
    <span class="kr">redeclare</span> <span class="kr">final</span> <span class="kr">package</span> <span class="nc">Medium</span> <span class="o">=</span> <span class="n">Medium</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">allowFlowReversal</span><span class="o">=</span><span class="n">allowFlowReversal</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">m_flow_small</span><span class="o">=</span><span class="n">m_flow_small</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">show_T</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">show_V_flow</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">Q_flow_maxHeat</span><span class="o">=</span><span class="n">Q_flow_maxHeat</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">Q_flow_maxCool</span><span class="o">=</span><span class="n">Q_flow_maxCool</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">m_flow_nominal</span><span class="o">=</span><span class="n">m_flow_nominal</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">T_start</span><span class="o">=</span><span class="n">T_start</span><span class="p">,</span>
    <span class="kr">final</span> <span class="n">energyDynamics</span><span class="o">=</span><span class="n">energyDynamics</span><span class="p">)</span> <span class="s2">&quot;Heater or cooler&quot;</span>
    <span class="kr">annotation</span> <span class="p">(</span><span class="n">Placement</span><span class="p">(</span><span class="n">transformation</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="mi">20</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="p">},{</span><span class="mi">40</span><span class="p">,</span><span class="mi">10</span><span class="p">}})));</span>
<span class="kr">equation</span>
  <span class="kr">connect</span><span class="p">(</span><span class="n">port_a</span><span class="p">,</span> <span class="n">preDro</span><span class="o">.</span><span class="n">port_a</span><span class="p">)</span> <span class="kr">annotation</span> <span class="p">(</span><span class="n">Line</span><span class="p">(</span>
      <span class="n">points</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span><span class="mi">0</span><span class="p">}},</span>
      <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">255</span><span class="p">}));</span>
  <span class="kr">connect</span><span class="p">(</span><span class="n">preDro</span><span class="o">.</span><span class="n">port_b</span><span class="p">,</span> <span class="n">heaCoo</span><span class="o">.</span><span class="n">port_a</span><span class="p">)</span> <span class="kr">annotation</span> <span class="p">(</span><span class="n">Line</span><span class="p">(</span>
      <span class="n">points</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">30</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">}},</span>
      <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">255</span><span class="p">}));</span>
  <span class="kr">connect</span><span class="p">(</span><span class="n">heaCoo</span><span class="o">.</span><span class="n">port_b</span><span class="p">,</span> <span class="n">port_b</span><span class="p">)</span> <span class="kr">annotation</span> <span class="p">(</span><span class="n">Line</span><span class="p">(</span>
      <span class="n">points</span><span class="o">=</span><span class="p">{{</span><span class="mi">40</span><span class="p">,</span><span class="mi">0</span><span class="p">},{</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">}},</span>
      <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">,</span><span class="mi">255</span><span class="p">}));</span>
  <span class="kr">connect</span><span class="p">(</span><span class="n">heaCoo</span><span class="o">.</span><span class="n">TSet</span><span class="p">,</span> <span class="n">TSet</span><span class="p">)</span> <span class="kr">annotation</span> <span class="p">(</span><span class="n">Line</span><span class="p">(</span>
      <span class="n">points</span><span class="o">=</span><span class="p">{{</span><span class="mi">18</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">0</span><span class="p">,</span><span class="mi">60</span><span class="p">},{</span><span class="o">-</span><span class="mi">120</span><span class="p">,</span><span class="mi">60</span><span class="p">}},</span>
      <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">}));</span>
  <span class="kr">connect</span><span class="p">(</span><span class="n">heaCoo</span><span class="o">.</span><span class="n">Q_flow</span><span class="p">,</span> <span class="n">Q_flow</span><span class="p">)</span> <span class="kr">annotation</span> <span class="p">(</span><span class="n">Line</span><span class="p">(</span>
      <span class="n">points</span><span class="o">=</span><span class="p">{{</span><span class="mi">41</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">72</span><span class="p">,</span><span class="mi">8</span><span class="p">},{</span><span class="mi">72</span><span class="p">,</span><span class="mi">60</span><span class="p">},{</span><span class="mi">110</span><span class="p">,</span><span class="mi">60</span><span class="p">}},</span>
      <span class="n">color</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">}));</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">Icon</span><span class="p">(</span><span class="n">coordinateSystem</span><span class="p">(</span><span class="n">preserveAspectRatio</span><span class="o">=</span><span class="kc">false</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span>
            <span class="o">-</span><span class="mi">100</span><span class="p">},{</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">}}),</span> <span class="n">graphics</span><span class="o">=</span><span class="p">{</span>
        <span class="n">Rectangle</span><span class="p">(</span>
          <span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span><span class="mi">60</span><span class="p">},{</span><span class="mi">60</span><span class="p">,</span><span class="o">-</span><span class="mi">60</span><span class="p">}},</span>
          <span class="n">lineColor</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">},</span>
          <span class="n">pattern</span><span class="o">=</span><span class="n">LinePattern</span><span class="o">.</span><span class="n">None</span><span class="p">,</span>
          <span class="n">fillColor</span><span class="o">=</span><span class="p">{</span><span class="mi">95</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">95</span><span class="p">},</span>
          <span class="n">fillPattern</span><span class="o">=</span><span class="n">FillPattern</span><span class="o">.</span><span class="n">Solid</span><span class="p">),</span>
        <span class="n">Rectangle</span><span class="p">(</span>
          <span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">102</span><span class="p">,</span><span class="mi">5</span><span class="p">},{</span><span class="mi">99</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">}},</span>
          <span class="n">lineColor</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">},</span>
          <span class="n">pattern</span><span class="o">=</span><span class="n">LinePattern</span><span class="o">.</span><span class="n">None</span><span class="p">,</span>
          <span class="n">fillColor</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
          <span class="n">fillPattern</span><span class="o">=</span><span class="n">FillPattern</span><span class="o">.</span><span class="n">Solid</span><span class="p">),</span>
        <span class="n">Rectangle</span><span class="p">(</span>
          <span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">60</span><span class="p">},{</span><span class="o">-</span><span class="mi">70</span><span class="p">,</span><span class="mi">58</span><span class="p">}},</span>
          <span class="n">lineColor</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">},</span>
          <span class="n">pattern</span><span class="o">=</span><span class="n">LinePattern</span><span class="o">.</span><span class="n">None</span><span class="p">,</span>
          <span class="n">fillColor</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">},</span>
          <span class="n">fillPattern</span><span class="o">=</span><span class="n">FillPattern</span><span class="o">.</span><span class="n">Solid</span><span class="p">),</span>
        <span class="n">Text</span><span class="p">(</span>
          <span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">106</span><span class="p">,</span><span class="mi">98</span><span class="p">},{</span><span class="o">-</span><span class="mi">62</span><span class="p">,</span><span class="mi">70</span><span class="p">}},</span>
          <span class="n">lineColor</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">},</span>
          <span class="n">textString</span><span class="o">=</span><span class="s2">&quot;T&quot;</span><span class="p">),</span>
        <span class="n">Rectangle</span><span class="p">(</span>
          <span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="mi">60</span><span class="p">,</span><span class="mi">60</span><span class="p">},{</span><span class="mi">100</span><span class="p">,</span><span class="mi">58</span><span class="p">}},</span>
          <span class="n">lineColor</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">},</span>
          <span class="n">pattern</span><span class="o">=</span><span class="n">LinePattern</span><span class="o">.</span><span class="n">None</span><span class="p">,</span>
          <span class="n">fillColor</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">},</span>
          <span class="n">fillPattern</span><span class="o">=</span><span class="n">FillPattern</span><span class="o">.</span><span class="n">Solid</span><span class="p">),</span>
        <span class="n">Text</span><span class="p">(</span>
          <span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="mi">72</span><span class="p">,</span><span class="mi">96</span><span class="p">},{</span><span class="mi">116</span><span class="p">,</span><span class="mi">68</span><span class="p">}},</span>
          <span class="n">lineColor</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">},</span>
          <span class="n">textString</span><span class="o">=</span><span class="s2">&quot;Q_flow&quot;</span><span class="p">)}),</span>
<span class="n">defaultComponentName</span><span class="o">=</span><span class="s2">&quot;hea&quot;</span><span class="p">,</span>
<span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
Model for an ideal heater or cooler with a prescribed outlet temperature.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model forces the outlet temperature at <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>port_b<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> to be equal to the temperature
of the input signal <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>TSet<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>, subject to optional limits on the
heating or cooling capacity <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Q_flow_max<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> and <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Q_flow_min<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>.
For unlimited capacity, set <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Q_flow_maxHeat = Modelica.Constant.inf<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>
and <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Q_flow_maxCool=-Modelica.Constant.inf<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
The output signal <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Q_flow<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> is the heat added (for heating) or subtracted (for cooling)
to the medium if the flow rate is from <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>port_a<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> to <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>port_b<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>.
If the flow is reversed, then <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Q_flow=0<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>.
The outlet temperature at <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>port_a<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> is not affected by this model.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
If the parameter <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>energyDynamics<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> is not equal to
<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>Modelica.Fluid.Types.Dynamics.SteadyState<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>,
the component models the dynamic response using a first order differential equation.
The time constant of the component is equal to the parameter <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>tau<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>.
This time constant is adjusted based on the mass flow rate using
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span> <span class="na">align</span><span class="o">=</span><span class="s">\&quot;center\&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">\&quot;font-style:italic;\&quot;</span><span class="p">&gt;</span>
<span class="ni">&amp;tau;</span><span class="p">&lt;</span><span class="nt">sub</span><span class="p">&gt;</span>eff<span class="p">&lt;/</span><span class="nt">sub</span><span class="p">&gt;</span> = <span class="ni">&amp;tau;</span> |m<span class="ni">&amp;#775;</span>| <span class="ni">&amp;frasl;</span> m<span class="ni">&amp;#775;</span><span class="p">&lt;</span><span class="nt">sub</span><span class="p">&gt;</span>nom<span class="p">&lt;/</span><span class="nt">sub</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
where
<span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span><span class="ni">&amp;tau;</span><span class="p">&lt;</span><span class="nt">sub</span><span class="p">&gt;</span>eff<span class="p">&lt;/</span><span class="nt">sub</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span> is the effective time constant for the given mass flow rate
<span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span>m<span class="ni">&amp;#775;</span><span class="p">&lt;/</span><span class="nt">i</span><span class="p">&gt;</span> and
<span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span><span class="ni">&amp;tau;</span><span class="p">&lt;/</span><span class="nt">i</span><span class="p">&gt;</span> is the time constant at the nominal mass flow rate
<span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span>m<span class="ni">&amp;#775;</span><span class="p">&lt;</span><span class="nt">sub</span><span class="p">&gt;</span>nom<span class="p">&lt;/</span><span class="nt">sub</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>.
This type of dynamics is equal to the dynamics that a completely mixed
control volume would have.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
Optionally, this model can have a flow resistance.
If no flow resistance is requested, set <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>dp_nominal=0<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
For a model that uses a control signal <span class="p">&lt;</span><span class="nt">i</span><span class="p">&gt;</span>u <span class="ni">&amp;isin;</span> [0, 1]<span class="p">&lt;/</span><span class="nt">i</span><span class="p">&gt;</span> and multiplies
this with the nominal heating or cooling power, use
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">\&quot;modelica://Buildings.Fluid.HeatExchangers.HeaterCooler_u\&quot;</span><span class="p">&gt;</span>
Buildings.Fluid.HeatExchangers.HeaterCooler_u<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h4</span><span class="p">&gt;</span>Limitations<span class="p">&lt;/</span><span class="nt">h4</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model only adds or removes heat for the flow from
<span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>port_a<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> to <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>port_b<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span>.
The enthalpy of the reverse flow is not affected by this model.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model does not affect the humidity of the air. Therefore,
if used to cool air below the dew point temperature, the water mass fraction
will not change.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">h4</span><span class="p">&gt;</span>Validation<span class="p">&lt;/</span><span class="nt">h4</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
The model has been validated against the analytical solution in
the examples
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">\&quot;modelica://Buildings.Fluid.HeatExchangers.Validation.HeaterCooler_T\&quot;</span><span class="p">&gt;</span>
Buildings.Fluid.HeatExchangers.Validation.HeaterCooler_T<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
and
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">\&quot;modelica://Buildings.Fluid.HeatExchangers.Validation.HeaterCooler_T_dynamic\&quot;</span><span class="p">&gt;</span>
Buildings.Fluid.HeatExchangers.Validation.HeaterCooler_T_dynamic<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">,</span>
<span class="n">revisions</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
December 1, 2016, by Michael Wetter:<span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
Updated model as <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>use_dh<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> is no longer a parameter in the pressure drop model.<span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
This is for
<span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">\&quot;https://github.com/ibpsa/modelica/issues/480\&quot;</span><span class="p">&gt;</span>#480<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>.
<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
November 11, 2014, by Michael Wetter:<span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
Revised implementation.
<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">li</span><span class="p">&gt;</span>
March 19, 2014, by Christoph Nytsch-Geusen:<span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
First implementation.
<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">HeaterCooler_T</span><span class="p">;</span>
</pre></div>
</div>
<p>When parse to a json representation, the output of its public declarations is as follows:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="s2">&quot;Buildings.Fluid.HeatExchangers.HeaterCooler_T&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Buildings.Fluid.HeatExchangers.HeaterCooler_T&quot;</span><span class="p">,</span>
    <span class="s2">&quot;comment&quot;</span><span class="o">:</span> <span class="s2">&quot;Ideal heater or cooler with a prescribed outlet temperature&quot;</span><span class="p">,</span>
    <span class="s2">&quot;qualifiers&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">&quot;model&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;superClasses&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;nameOfExtendedClass&quot;</span><span class="o">:</span> <span class="s2">&quot;Buildings.Fluid.Interfaces.PartialTwoPortInterface&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;nameOfExtendedClass&quot;</span><span class="o">:</span> <span class="s2">&quot;Buildings.Fluid.Interfaces.TwoPortFlowResistanceParameters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;modifications&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;computeFlowResistance&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;qualifiers&quot;</span><span class="o">:</span> <span class="p">[</span>
                        <span class="s2">&quot;final&quot;</span>
                    <span class="p">],</span>
                    <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;abs(dp_nominal)&gt;Modelica.Constants.eps&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;nameOfExtendedClass&quot;</span><span class="o">:</span> <span class="s2">&quot;Buildings.Fluid.Interfaces.PrescribedOutletStateParameters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;modifications&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;T_start&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;Medium.T_default&quot;</span>
                <span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;components&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;className&quot;</span><span class="o">:</span> <span class="s2">&quot;Boolean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;qualifiers&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;parameter&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;homotopyInitialization&quot;</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="o">:</span> <span class="s2">&quot;= true, use homotopy method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
            <span class="s2">&quot;annotations&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;dialog&quot;</span><span class="o">:</span> <span class="s2">&quot;Dialog(tab = \&quot;Advanced\&quot;)&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;className&quot;</span><span class="o">:</span> <span class="s2">&quot;Modelica.Blocks.Interfaces.RealInput&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;TSet&quot;</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="o">:</span> <span class="s2">&quot;Set point temperature of the fluid that leaves port_b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;modifications&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;unit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;\&quot;K\&quot;&quot;</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;displayUnit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;\&quot;degC\&quot;&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;annotations&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;placement&quot;</span><span class="o">:</span> <span class="s2">&quot;Placement(transformation(extent = {{-140,40},{-100,80}}))&quot;</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;className&quot;</span><span class="o">:</span> <span class="s2">&quot;Modelica.Blocks.Interfaces.RealOutput&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;Q_flow&quot;</span><span class="p">,</span>
            <span class="s2">&quot;comment&quot;</span><span class="o">:</span> <span class="s2">&quot;Heat added to the fluid (if flow is from port_a to port_b)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;modifications&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;unit&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="o">:</span> <span class="s2">&quot;\&quot;W\&quot;&quot;</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="s2">&quot;annotations&quot;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&quot;placement&quot;</span><span class="o">:</span> <span class="s2">&quot;Placement(transformation(extent = {{100,50},{120,70}}))&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">],</span>
    <span class="s2">&quot;annotations&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;documentationInfo&quot;</span><span class="o">:</span> <span class="s2">&quot;info = \&quot;&lt;html&gt;\n&lt;p&gt;\nModel for an ideal heater or cooler with</span>
<span class="s2">        a prescribed outlet temperature.\n&lt;/p&gt;\n&lt;p&gt;\nThis model forces the outlet temperature at &lt;code&gt;port_b&lt;/code&gt;</span>
<span class="s2">        [further text has been omitted]</span>
<span class="s2">        &lt;/html&gt;\&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;icon&quot;</span><span class="o">:</span> <span class="s2">&quot;Icon(coordinateSystem(preserveAspectRatio = false,</span>
<span class="s2">                       extent = {{-100,-100},{100,100}}),</span>
<span class="s2">                       graphics = {Rectangle(),Rectangle(),Rectangle(),Text(),Rectangle(),Text()})&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Hence, OpenStudio can reads its parameters from the json file. Note that it also will need to parse the json
representation from the <code class="docutils literal"><span class="pre">superClasses</span></code>, for example
to obtain the connectors and parameters, including their modifications, from
<code class="docutils literal"><span class="pre">Buildings.Fluid.Interfaces.PartialTwoPortInterface</span></code>.</p>
</div>
<div class="section" id="summary-of-questions-and-next-steps">
<h4>5.1.1.5. Summary of Questions and Next Steps<a class="headerlink" href="#summary-of-questions-and-next-steps" title="Permalink to this headline">¶</a></h4>
<p><strong>Questions</strong>:</p>
<ul class="simple">
<li>What pre-processing on the extracted data would be useful?</li>
</ul>
<p><strong>Next Steps</strong>:</p>
<ul class="simple">
<li>Make a decision as to the JModelica API to use</li>
<li>Determine what constitutes a significant difference between different versions of the
Modelica Buildings Library and how to communicate those</li>
<li>Write the proposed programs using JModelica to extract AST data from Modelica
Models in a library and write that data out as XML.</li>
<li>Create diff tool for comparing versions of the MBL in a meaningful way</li>
</ul>
<p class="rubric">Footnotes</p>
<table class="docutils footnote" frame="void" id="fn-mbl" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Our main focus is to support the Modelica Buildings Library but
the tool should also work for other Modelica libraries.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="jmodelica-integration">
<h2>5.2. JModelica Integration<a class="headerlink" href="#jmodelica-integration" title="Permalink to this headline">¶</a></h2>
<p>This section describes the integration of the QSS solver in JModelica.</p>
<p>We will first introduce terminology.
Consider the code-snippet</p>
<div class="highlight-modelica"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="kr">when</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">a</span><span class="p">)</span> <span class="kr">then</span>
  <span class="o">...</span>
<span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
<span class="o">...</span>
</pre></div>
</div>
<p>We will say that <span class="math">\(z = a - x\)</span> is the <em>event indicator</em>.</p>
<p>For the discussion, we consider a system of initial value ODEs of the form</p>
<div class="math" id="equation-eqn_ini_val">
<span class="eqno">(1)</span>\[\begin{split}[\dot x_c(t), x_d(t)] &amp; = f(x_c(t), x_d(t^-), u_c(t), u_d(t), p, t),\end{split}\]\[\begin{split}[y_c(t), y_d(t)] &amp; = g(x_c(t), x_d(t), u_c(t), u_d(t), p, t),\\\end{split}\]\[\begin{split}0         &amp; = z(x_c(t), x_d(t), u_c(t), u_d(t), p, t),\\\end{split}\]\[\begin{split}[x_c(t_0), x_d(t_0)] &amp; = [x_{c,0}, x_{d,0}],\end{split}\]</div>
<p>where
<span class="math">\(x(\cdot)\)</span> is the continuous-time state vector, with superscript
<span class="math">\(c\)</span> denoting continuous-time states and <span class="math">\(d\)</span> denoting discrete variables or states,
<span class="math">\(u(\cdot)\)</span> is the external input,
<span class="math">\(p\)</span> are parameters,
<span class="math">\(f(\cdot, \cdot, \cdot, \cdot, \cdot, \cdot)\)</span> is the state transitions function,
<span class="math">\(g(\cdot, \cdot, \cdot, \cdot, \cdot, \cdot)\)</span> is the output function,
<span class="math">\(z(\cdot, \cdot, \cdot, \cdot, \cdot, \cdot)\)</span> is the event indicator (sometimes called zero crossing function).</p>
<p>Because we anticipate that the FMU can have
direct feed-through from the input
<span class="math">\(u(t)\)</span> to the output <span class="math">\(y(t)\)</span>, we use
FMI for Model-Exchange (FMI-ME) version 2.0, because the Co-Simulation
standard does not allow a zero time step size as needed for direct feed-through.</p>
<p><a class="reference internal" href="#fig-sof-arc-qss-jmod2"><span class="std std-numref">Fig. 5.2</span></a> shows the software architecture
with the extended FMI API.
For simplicity the figure only
shows single FMUs, but we anticipated having multiple interconnected FMUs.</p>
<div class="figure" id="id13">
<span id="fig-sof-arc-qss-jmod2"></span><p class="plantuml">
<object data="_images/plantuml-b3ecc8819a2c8ff59f101d387a12958a807f7582.svg" type="image/svg+xml" style="width:820px;height:419px;">
<img src="_images/plantuml-b3ecc8819a2c8ff59f101d387a12958a807f7582.png" alt="title Software architecture for QSS integration with JModelica with extended FMI API

skinparam componentStyle uml2

package FMU-QSS {
  [QSS solver] as qss_sol
  [FMU-ME] as FMU_QSS
}

package PyFMI {
[Master algorithm] -&gt; qss_sol : &quot;inputs, time&quot;
[Master algorithm] &lt;- qss_sol : &quot;next event time, states&quot;
[Master algorithm] - [Sundials]
}

[Sundials] -&gt; [FMU-ME] : &quot;(x, t)&quot;
[Sundials] &lt;- [FMU-ME] : &quot;dx/dt&quot;
[Master algorithm] -&gt; [FMU-CS] : &quot;hRequested&quot;
[Master algorithm] &lt;- [FMU-CS] : &quot;(x, hMax)&quot;

package Optimica {
[JModelica compiler] as jmc
}

jmc -&gt; FMU_QSS

FMU_QSS -down-&gt; qss_sol : &quot;derivatives&quot;
qss_sol -down-&gt; FMU_QSS : &quot;inputs, time, states&quot;" />

</object></p>
<p class="caption"><span class="caption-number">Fig. 5.2 </span>: Software architecture for QSS integration with JModelica
with extended FMI API.<a class="headerlink" href="#id13" title="Permalink to this image">¶</a></p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">We still need to design how to handle algebraic loops inside the FMU
(see also Cellier&#8217;s and Kofman&#8217;s book) and algebraic loops that
cross multiple FMUs.</p>
</div>
<p>The QSS solvers require the derivatives shown in <a class="reference internal" href="#tab-qss-der"><span class="std std-numref">Table 5.1</span></a>.</p>
<table border="1" class="docutils" id="id14">
<span id="tab-qss-der"></span><caption><span class="caption-number">Table 5.1 </span><span class="caption-text">Derivatives required by QSS algorithms. One asteriks indicates
        that they are provided by FMI-ME 2.0, and two asteriks indicate
        that they can optionally be computed exactly if directional
        derivatives are provided by the FMU.
        The others cannot be provided through the FMI API.</span><a class="headerlink" href="#id14" title="Permalink to this table">¶</a></caption>
<colgroup>
<col width="10%" />
<col width="50%" />
<col width="40%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Type of QSS</th>
<th class="head">Continuous-time state derivative</th>
<th class="head">event indicator derivative</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>QSS1</td>
<td><span class="math">\(dx_c/dt\)</span> *</td>
<td><span class="math">\(dz/dt\)</span></td>
</tr>
<tr class="row-odd"><td>QSS2</td>
<td><span class="math">\(dx_c/dt\)</span> * , <span class="math">\(d^2x_c/dt^2\)</span> **</td>
<td><span class="math">\(dz/dt\)</span> , <span class="math">\(d^2z/dt^2\)</span></td>
</tr>
<tr class="row-even"><td>QSS3</td>
<td><span class="math">\(dx_c/dt\)</span> * , <span class="math">\(d^2x_c/dt^2\)</span> ** , <span class="math">\(d^3x_c/dt^3\)</span></td>
<td><span class="math">\(dz/dt\)</span> , <span class="math">\(d^2z/dt^2\)</span>, <span class="math">\(d^3z/dt^3\)</span></td>
</tr>
</tbody>
</table>
<p>Because the FMI API does not provide access to the required derivatives,
and FMI has limited support for QSS, we discuss extensions
that are needed for an efficient implementation of QSS.</p>
<div class="section" id="fmi-changes-for-qss">
<h3>5.2.1. FMI Changes for QSS<a class="headerlink" href="#fmi-changes-for-qss" title="Permalink to this headline">¶</a></h3>
<p>QSS generally requires to only update a subset of the continuous-time state vector. We therefore
propose to use the function</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">fmi2Status</span> <span class="nf">fmi2SetReal</span><span class="p">(</span><span class="n">fmi2Component</span> <span class="n">c</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">fmi2Real</span> <span class="n">x</span><span class="p">[],</span>
                       <span class="k">const</span> <span class="n">fmi2ValueReference</span> <span class="n">vr</span><span class="p">[],</span>
                       <span class="kt">size_t</span> <span class="n">nx</span><span class="p">);</span>
</pre></div>
</div>
<p>to set a subset of the continuous-time state vector.
This function exists in FMI-ME 2.0, but the standard only allows to call it for
continuous-time state variables during the initialization.</p>
<p>We therefore propose that the standard is being changed as follows:</p>
<blockquote>
<div><code class="docutils literal"><span class="pre">fmi2SetReal</span></code> can be called during the continuous time mode
and during event mode not only for inputs,
as is allowed in FMI-ME 2.0, but also for continuous-time states.</div></blockquote>
<p>To retrieve individual state derivatives, we introduce the extensions
shown in <a class="reference internal" href="#fig-der-ext"><span class="std std-numref">Listing 5.1</span></a>
to the <code class="docutils literal"><span class="pre">&lt;Derivatives&gt;</span></code> element of the <code class="docutils literal"><span class="pre">modelDescription.xml</span></code> file.</p>
<div class="literal-block-wrapper docutils container" id="id15">
<span id="fig-der-ext"></span><div class="code-block-caption"><span class="caption-number">Listing 5.1 </span><span class="caption-text">Extensions for obtaining higher order state derivatives. XML additions are marked yellow.</span><a class="headerlink" href="#id15" title="Permalink to this code">¶</a></div>
<div class="highlight-xml"><div class="highlight"><pre><span></span> &lt;ModelVariables&gt; &lt;!-- Remains unchanged --&gt;
   ...
   &lt;ScalarVariable name=&quot;x&quot;,      ...&gt; ... &lt;/ScalarVariable&gt; &lt;!-- index=&quot;5&quot; --&gt;
   ...
   &lt;ScalarVariable name=&quot;der(x)&quot;, ...&gt; ... &lt;/ScalarVariable&gt; &lt;!-- index=&quot;8&quot; --&gt;
 &lt;/ModelVariables&gt;

 &lt;Derivatives&gt;
   &lt;!-- The ScalarVariable with index 8 is der(x) --&gt;
   &lt;Unknown     index=&quot;8&quot; dependencies=&quot;6&quot; /&gt;
<span class="hll">   &lt;!-- index 5 is the index of the state variable x --&gt;
</span><span class="hll">   &lt;HigherOrder index=&quot;5&quot; order=&quot;2&quot; value_reference=&quot;124&quot; /&gt; &lt;!-- This is d^2 x/dt^2 --&gt;
</span>   &lt;HigherOrder index=&quot;5&quot; order=&quot;3&quot; value_reference=&quot;125&quot; /&gt; &lt;!-- This is d^3 x/dt^3 --&gt;
 &lt;/Derivatives&gt;
</pre></div>
</div>
</div>
<div class="section" id="event-handling">
<h4>5.2.1.1. Event Handling<a class="headerlink" href="#event-handling" title="Permalink to this headline">¶</a></h4>
<div class="section" id="state-events">
<span id="subsec-se"></span><h5>5.2.1.1.1. State Events<a class="headerlink" href="#state-events" title="Permalink to this headline">¶</a></h5>
<p>For efficiency, QSS requires to know the dependencies
of event indicators. Also, it will need to
have access to, or else approximate numerically, the time derivatives of the
event indicator. FMI 2.0 outputs an array of real-valued event indicators,
but no variable dependencies.</p>
<p>Therefore, we introduce the following xml section, which assumes we have
three event indicators.</p>
<div class="highlight-xml"><div class="highlight"><pre><span></span><span class="nt">&lt;ModelStructure&gt;</span>
  <span class="nt">&lt;EventIndicators&gt;</span>
    <span class="c">&lt;!-- This is z[0] which depends on ScalarVariable with index 2 and 3 --&gt;</span>
    <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">order=</span><span class="s">&quot;0&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;2 3&quot;</span> <span class="na">value_reference=</span><span class="s">&quot;200&quot;</span> <span class="nt">/&gt;</span>
    <span class="c">&lt;!-- This is z[1] which declares no dependencies, hence it may depend on everything --&gt;</span>
    <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;2&quot;</span> <span class="na">order=</span><span class="s">&quot;0&quot;</span> <span class="na">value_reference=</span><span class="s">&quot;201&quot;</span> <span class="nt">/&gt;</span>
     <span class="c">&lt;!-- This is z[2] which declares that it depends only on time --&gt;</span>
    <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;3&quot;</span> <span class="na">order=</span><span class="s">&quot;0&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;&quot;</span> <span class="na">value_reference=</span><span class="s">&quot;202&quot;</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- With order &gt; 0, higher order derivatives can be specified. --&gt;</span>
    <span class="c">&lt;!-- This is dz[0]/dt which depends on scalar variable 2 --&gt;</span>
    <span class="nt">&lt;Element</span> <span class="na">index=</span><span class="s">&quot;1&quot;</span> <span class="na">order=</span><span class="s">&quot;1&quot;</span> <span class="na">value_reference=</span><span class="s">&quot;210&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/EventIndicators&gt;</span>
<span class="nt">&lt;/ModelStructure&gt;</span>
</pre></div>
</div>
<p>The attribute <code class="docutils literal"><span class="pre">dependencies</span></code> is optional. However, if it is not specified,
a tool would need to assume that the event indicator depends on all variables.
Write <code class="docutils literal"><span class="pre">dependencies=&quot;&quot;</span></code> to declare that this event indicator depends on no variable
(other than possibly time).
Note that for performance reasons, for QSS <code class="docutils literal"><span class="pre">dependencies</span></code> should be declared
for <code class="docutils literal"><span class="pre">order=&quot;0&quot;</span></code>. For higher order, QSS does not use the dependencies.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The <code class="docutils literal"><span class="pre">index</span></code> uses in the <code class="docutils literal"><span class="pre">&lt;EventIndicators&gt;</span></code> element is different from the <code class="docutils literal"><span class="pre">index</span></code>
used in the <code class="docutils literal"><span class="pre">&lt;ModelVariables&gt;</span></code> element. The first event indicator has an <code class="docutils literal"><span class="pre">index</span></code> 1,
the second has an <code class="docutils literal"><span class="pre">index</span></code> 2, and so on. A new index is introduced because the event
indicators do not show up in the list of <code class="docutils literal"><span class="pre">&lt;ModelVariables&gt;</span></code>.</p>
<p>The dependencies variables of event indicators are</p>
<ul class="last simple">
<li>inputs (variables with causality = &#8220;input&#8221;)</li>
<li>continuous-time states</li>
<li>independent variable (usually time; causality = &#8220;independent&#8221;)</li>
</ul>
</div>
<p>Consider the following model</p>
<div class="highlight-modelica"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">StateEvent1</span> <span class="s2">&quot;This model tests state event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x1</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x2</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="kr">discrete</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealOutput</span> <span class="n">y</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span>
    <span class="s2">&quot;Ouput variable&quot;</span><span class="p">;</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
  <span class="kr">when</span> <span class="p">(</span><span class="n">x1</span> <span class="o">&gt;</span> <span class="mf">0.5</span> <span class="ow">and</span> <span class="n">x2</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has 2 state events, one at t=0.25
and one at t=0.6924 when simulated from 0 to 1 s.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">StateEvent1</span><span class="p">;</span>
</pre></div>
</div>
<p>For efficiency reason, QSS requires the FMU which exports this model to indicate in its model description file
the dependency of <code class="docutils literal"><span class="pre">der(x1)</span></code> on <code class="docutils literal"><span class="pre">y</span></code>. This allows <code class="docutils literal"><span class="pre">der(x1)</span></code> to update when <code class="docutils literal"><span class="pre">y</span></code> changes.
However, <code class="docutils literal"><span class="pre">y</span></code> can only change when an event indicator changes its domain. Hence,
rather than declaring the dependency on <code class="docutils literal"><span class="pre">y</span></code>, it suffices to declare the dependency on
the event indicator.
Therefore, we propose to
include event indicators to the list of state derivative dependencies.</p>
<p>However, FMI states on page 61 that <code class="docutils literal"><span class="pre">dependencies</span></code> are optional attributes
defining the dependencies of the unknown (directly or indirectly via auxiliary variables)
with respect to known.
For state derivatives and outputs, known variables are</p>
<ul class="simple">
<li>inputs (variables with causality = &#8220;input&#8221;)</li>
<li>continuous-time states</li>
<li>independent variable (usually time; causality = &#8220;independent&#8221;)</li>
</ul>
<p>Therefore we require to extend the <code class="docutils literal"><span class="pre">&lt;Derivatives&gt;</span></code> element
with a new attribute <code class="docutils literal"><span class="pre">ei_dependencies</span></code> which lists
all event indicator variables which trigger
changes to state derivative trajectories.</p>
<p>An excerpt of such a <code class="docutils literal"><span class="pre">&lt;Derivatives&gt;</span></code> element with the new addition is
shown in <a class="reference internal" href="#fig-hig-der"><span class="std std-numref">Listing 5.2</span></a>.</p>
<div class="literal-block-wrapper docutils container" id="id16">
<span id="fig-hig-der"></span><div class="code-block-caption"><span class="caption-number">Listing 5.2 </span><span class="caption-text">Extensions with inclusion of a new attribute for event indicator dependencies. XML additions are marked yellow.</span><a class="headerlink" href="#id16" title="Permalink to this code">¶</a></div>
<div class="highlight-xml"><div class="highlight"><pre><span></span>  <span class="nt">&lt;Derivatives&gt;</span>
    <span class="c">&lt;!-- The ScalarVariable with index 8 is der(x) --&gt;</span>
<span class="hll">    <span class="c">&lt;!-- ei_dependencies=&quot;1&quot; declares that der(x) depends on the event indicator with index 1  --&gt;</span>
</span>    <span class="nt">&lt;Unknown</span>     <span class="na">index=</span><span class="s">&quot;8&quot;</span> <span class="na">dependencies=</span><span class="s">&quot;6&quot;</span> <span class="na">ei_dependencies=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
    <span class="c">&lt;!-- index 5 is the index of the state variable x --&gt;</span>
    <span class="nt">&lt;HigherOrder</span> <span class="na">index=</span><span class="s">&quot;5&quot;</span> <span class="na">order=</span><span class="s">&quot;2&quot;</span> <span class="na">value_reference=</span><span class="s">&quot;124&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- This is d^2 x/dt^2 --&gt;</span>
    <span class="nt">&lt;HigherOrder</span> <span class="na">index=</span><span class="s">&quot;5&quot;</span> <span class="na">order=</span><span class="s">&quot;3&quot;</span> <span class="na">value_reference=</span><span class="s">&quot;125&quot;</span> <span class="nt">/&gt;</span> <span class="c">&lt;!-- This is d^3 x/dt^3 --&gt;</span>
  <span class="nt">&lt;/Derivatives&gt;</span>
</pre></div>
</div>
</div>
<p>For the elements <code class="docutils literal"><span class="pre">Unknown</span></code> and <code class="docutils literal"><span class="pre">HigherOrder</span></code>, the
attributes <code class="docutils literal"><span class="pre">dependencies</span></code> and <code class="docutils literal"><span class="pre">ei_dependencies</span></code> are optional.
However, if <code class="docutils literal"><span class="pre">dependencies</span></code> is not declared,
a tool would need to assume that they
depend on all variables.
Similarly, if <code class="docutils literal"><span class="pre">ei_dependencies</span></code> is not declared,
a tool would need to assume that they
depend on all event indicators.
Write <code class="docutils literal"><span class="pre">dependencies=&quot;&quot;</span></code> to declare that this derivative depends on no variable.
Similarly,
write <code class="docutils literal"><span class="pre">ei_dependencies=&quot;&quot;</span></code> to declare that this derivative depends on no event indicator.
Note that for performance reasons, for QSS <code class="docutils literal"><span class="pre">dependencies</span></code> and <code class="docutils literal"><span class="pre">ei_dependencies</span></code> should be declared
for <code class="docutils literal"><span class="pre">Unknown</span></code>. For <code class="docutils literal"><span class="pre">HigherOrder</span></code>, QSS does not use the
<code class="docutils literal"><span class="pre">dependencies</span></code> and <code class="docutils literal"><span class="pre">ei_dependencies</span></code>.</p>
<p>In <a class="reference internal" href="#fig-hig-der"><span class="std std-numref">Listing 5.2</span></a>, the higher order derivatives depend on the event indicator.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The indexes of <code class="docutils literal"><span class="pre">ei_dependencies</span></code> are the indexes of the
event indicators specified in the <code class="docutils literal"><span class="pre">&lt;EventIndicators&gt;</span></code> element.</p>
</div>
</div>
<div class="section" id="event-indicators-that-depend-on-the-input">
<span id="subsec-te"></span><h5>5.2.1.1.2. Event indicators that depend on the input<a class="headerlink" href="#event-indicators-that-depend-on-the-input" title="Permalink to this headline">¶</a></h5>
<p>Consider following model</p>
<div class="highlight-modelica"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">StateEvent2</span> <span class="s2">&quot;This model tests state event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x</span><span class="p">(</span><span class="n">start</span><span class="o">=-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="kr">discrete</span> <span class="nb">Real</span> <span class="n">y</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span> <span class="s2">&quot;Discrete variable&quot;</span><span class="p">);</span>
  <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealInput</span> <span class="n">u</span> <span class="s2">&quot;Input variable&quot;</span>
    <span class="kr">annotation</span> <span class="p">(</span><span class="n">Placement</span><span class="p">(</span><span class="n">transformation</span><span class="p">(</span><span class="n">extent</span><span class="o">=</span><span class="p">{{</span><span class="o">-</span><span class="mi">140</span><span class="p">,</span><span class="o">-</span><span class="mi">20</span><span class="p">},{</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">20</span><span class="p">}})));</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
  <span class="kr">when</span> <span class="p">(</span><span class="n">u</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has a state event
when u becomes bigger than x.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">StateEvent2</span><span class="p">;</span>
</pre></div>
</div>
<p>This model has one event indicator <span class="math">\(z = u-x\)</span>.
The derivative of the event indicator is <span class="math">\(\frac{dz}{dt} = \frac{du}{dt} - \frac{dx}{dt}\)</span>.</p>
<p>Hence, a tool will need the derivative of the input <code class="docutils literal"><span class="pre">u</span></code>
to compute the derivative of the event indicator.
Since the derivative of the input <code class="docutils literal"><span class="pre">u</span></code> is unkown in the FMU,
we propose for cases where the event indicator
has a direct feedthrough on the input to exclude
event indicator derivatives from the <code class="docutils literal"><span class="pre">&lt;EventIndicators&gt;</span></code>
element. In this situation, the QSS solver will detect the missing
information from the XML file and numerically approximate
the event indicator derivatives.</p>
</div>
<div class="section" id="workaround-for-implementing-event-indicators">
<h5>5.2.1.1.3. Workaround for implementing event indicators<a class="headerlink" href="#workaround-for-implementing-event-indicators" title="Permalink to this headline">¶</a></h5>
<p>While waiting for the implementation of the FMI extensions in JModelica,
LBNL will refactor some Modelica models to expose event indicators and their first derivatives as FMU output variables.</p>
<p>The names of event indicators variables will start with <code class="docutils literal"><span class="pre">__zc_</span></code>. The names of derivatives of event
indicators will start with <code class="docutils literal"><span class="pre">__zc_der_</span></code>.  As an example, <code class="docutils literal"><span class="pre">__zc_z1</span></code> and <code class="docutils literal"><span class="pre">__zc_der_z1</span></code>
are the names of the event indicator <code class="docutils literal"><span class="pre">z1</span></code> with its derivative <code class="docutils literal"><span class="pre">der_z1</span></code>.</p>
<p>If the number of event indicators is equal to the <code class="docutils literal"><span class="pre">numberOfEventIndicators</span></code> attribute,
then only <code class="docutils literal"><span class="pre">__zc_</span></code> and <code class="docutils literal"><span class="pre">__zc_der_</span></code> need to be used by QSS.
If the number of event indicators does not match, the FMU needs to be rejected with an error message.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Per design, Dymola (2018) generates twice as many event indicators as actually existing in the model.
Hence the master algorithm needs to detect if the tool which exported the FMU is Dymola, and if it is, the
number of event indicators must be equal to half the value of the <code class="docutils literal"><span class="pre">numberOfEventIndicators</span></code> attribute.</p>
</div>
</div>
<div class="section" id="time-events">
<h5>5.2.1.1.4. Time Events<a class="headerlink" href="#time-events" title="Permalink to this headline">¶</a></h5>
<p>This section discusses additional requirements for handling time events with QSS.</p>
<p>Consider following model</p>
<div class="highlight-modelica"><div class="highlight"><pre><span></span><span class="kr">within</span> <span class="nn">QSS</span><span class="o">.</span><span class="n">Docs</span><span class="p">;</span>
<span class="kr">model</span> <span class="nc">TimeEvent</span> <span class="s2">&quot;This model tests time event detection&quot;</span>
  <span class="kr">extends</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Icons</span><span class="o">.</span><span class="n">Example</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x1</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="nb">Real</span> <span class="n">x2</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span> <span class="s2">&quot;State variable&quot;</span><span class="p">;</span>
  <span class="kr">discrete</span> <span class="n">Modelica</span><span class="o">.</span><span class="n">Blocks</span><span class="o">.</span><span class="n">Interfaces</span><span class="o">.</span><span class="n">RealOutput</span> <span class="n">y</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">true</span><span class="p">)</span>
    <span class="s2">&quot;Output variable&quot;</span><span class="p">;</span>
<span class="kr">equation</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kr">der</span><span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x2</span><span class="p">;</span>
  <span class="kr">when</span> <span class="p">(</span><span class="nb">time</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="kr">then</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">x2</span><span class="p">;</span>
  <span class="kr">end</span> <span class="kr">when</span><span class="p">;</span>
  <span class="kr">annotation</span> <span class="p">(</span><span class="n">experiment</span><span class="p">(</span><span class="n">StopTime</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">Documentation</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="s2">&quot;</span><span class="p">&lt;</span><span class="nt">html</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>
This model has 1 time event at t=0.5s
when simulated from 0 to 1s.
<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span><span class="s2">&quot;</span><span class="p">));</span>
<span class="kr">end</span> <span class="nc">TimeEvent</span><span class="p">;</span>
</pre></div>
</div>
<p>This model has a time event at <span class="math">\(t \ge 0.5\)</span>.
For efficiency, QSS requires the FMU which exports
this model to indicate in its model description file
the dependency of <code class="docutils literal"><span class="pre">der(x1)</span></code> on <code class="docutils literal"><span class="pre">y</span></code>.
However, since <code class="docutils literal"><span class="pre">y</span></code> updates when a time event happens
but a time event is not described with event indicator,
it is not possible to use the same approach as done for
<code class="docutils literal"><span class="pre">StateEvent1</span></code>.</p>
<p>We therefore propose to extend the FMI specification to</p>
<ul>
<li><p class="first">include a new data structure <code class="docutils literal"><span class="pre">fmi2ExtendedEventInfo</span></code> and a new function <code class="docutils literal"><span class="pre">fmi2ExtendedNewDiscreteStates</span></code>.
<code class="docutils literal"><span class="pre">fmi2ExtendedNewDiscreteStates</span></code> is similar to <code class="docutils literal"><span class="pre">fmi2NewDiscreteStates</span></code> but includes the value references
of all variables changed because of a time event (e.g. the variable <code class="docutils literal"><span class="pre">y</span></code>).
We call these variables <code class="docutils literal"><span class="pre">TimeEventHandlers</span></code>. The data structure and new functions are</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span><span class="p">{</span>
 <span class="n">fmi2Boolean</span> <span class="n">newDiscreteStatesNeeded</span><span class="p">;</span>
 <span class="n">fmi2Boolean</span> <span class="n">terminateSimulation</span><span class="p">;</span>
 <span class="n">fmi2Boolean</span> <span class="n">nominalsOfContinuousStatesChanged</span><span class="p">;</span>
 <span class="n">fmi2Boolean</span> <span class="n">valuesOfContinuousStatesChanged</span><span class="p">;</span>
 <span class="n">fmi2Boolean</span> <span class="n">nextEventTimeDefined</span><span class="p">;</span>
 <span class="n">fmi2Real</span> <span class="n">nextEventTime</span><span class="p">;</span> <span class="c1">// next event if nextEventTimeDefined=fmi2True</span>
<span class="hll"> <span class="n">fmi2ValueReference</span> <span class="n">valueReferences</span> <span class="p">[];</span>
</span> <span class="kt">size_t</span> <span class="n">nvr</span><span class="p">;</span> <span class="c1">// size of valueReferences</span>
 <span class="p">}</span> <span class="n">fmi2ExtendeEventInfo</span><span class="p">;</span>
</pre></div>
</div>
<p>If <code class="docutils literal"><span class="pre">nvr</span> <span class="pre">=</span> <span class="pre">0</span></code>, then no state is affected by the time event.
(<code class="docutils literal"><span class="pre">nvr</span> <span class="pre">=</span> <span class="pre">0</span></code> may be a special case, for example if a model writes to disk.)
If <code class="docutils literal"><span class="pre">nvr</span> <span class="pre">&gt;</span> <span class="pre">0</span></code>, then <code class="docutils literal"><span class="pre">valueReferences</span></code> contains that value references of
all variables that are updated at that event. (From the xml file, one can
see which states then need to be updated.)
If <code class="docutils literal"><span class="pre">nvr</span> <span class="pre">&lt;</span> <span class="pre">0</span></code>, then a tool does not say what variables are updated. This
may be required if an FMU protects its variables to protect intellectual property.
However, for QSS efficiency, we should have <code class="docutils literal"><span class="pre">nvr</span> <span class="pre">&gt;=</span> <span class="pre">0</span></code>.</p>
<div class="highlight-C"><div class="highlight"><pre><span></span><span class="n">fmi2Status</span> <span class="nf">fmi2ExtendedNewDiscreteStates</span><span class="p">(</span><span class="n">fmi2Component</span> <span class="n">c</span><span class="p">,</span>
 <span class="n">fmi2ExtendedEventInfo</span><span class="o">*</span> <span class="n">fmi2ExtendedEventInfo</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p class="first">extend the <code class="docutils literal"><span class="pre">dependencies</span></code> attribute of state derivatives to
include the indexes of <code class="docutils literal"><span class="pre">TimeEventHandlers</span></code>. <code class="docutils literal"><span class="pre">TimeEventHandlers</span></code> are
scalar variables listed in the <code class="docutils literal"><span class="pre">&lt;ModelVariables&gt;</span></code> element of the model
description file.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="smoothtoken-for-qss">
<h4>5.2.1.2. SmoothToken for QSS<a class="headerlink" href="#smoothtoken-for-qss" title="Permalink to this headline">¶</a></h4>
<p>This section discusses a proposal for a new data type which should be used for input and output variables of FMU-QSS.
FMU-QSS is an FMU for Model Exchange (FMU-ME) which uses QSS to integrate an imported FMU-ME.
We propose that FMU-QSS communicates with other FMUs using a SmoothToken data type.</p>
<p>A smooth token is a time-stamped event that has a real value (approximated as a <code class="docutils literal"><span class="pre">double</span></code>)
that represents the current sample of a real-valued smooth signal. But in addition to the sample value,
the smooth token contains zero or more time-derivatives of the signal at the stored time stamp.
For example, in the figure below, FMU-ME has a real input <span class="math">\(u\)</span> and a real output <span class="math">\(y\)</span>.
A smooth token of the input variable will be a variable <span class="math">\(u^* \triangleq [u, n, du/dt, ...,  d^n u/dt^n, t_u]\)</span>,
where <span class="math">\(n \in \{0, 1, 2, \ldots \}\)</span> is a parameter that defines the number of time derivatives that are present in the smooth token and
<span class="math">\(t_u\)</span> is the timestamp of the smooth token.
If <span class="math">\(u^*\)</span> has a discontinuity at <span class="math">\(t_u\)</span>,
then the derivatives are the derivatives from above, e.g., <span class="math">\(du/dt \triangleq \lim_{s \downarrow 0} (u(t_u+s)-u(t_u))/s\)</span>.</p>
<p>At simulation time <span class="math">\(t\)</span>, FMU-QSS will receive <span class="math">\(u^*\)</span> and convert it to a real signal
using the Taylor expansion</p>
<div class="math">
\[y_s(t) = \frac{u^{(n)}(t_u)}{n!} \, (t-t_u)^n,\]</div>
<p>where <span class="math">\(u^{(n)}\)</span> denotes the <span class="math">\(n\)</span>-th derivative. As shown in <a class="reference internal" href="#fig-fmu-qss"><span class="std std-numref">Fig. 5.3</span></a>, the FMU-ME will receive
the value <span class="math">\(y_s(t)\)</span>.</p>
<div class="figure" id="id17">
<span id="fig-fmu-qss"></span><a class="reference internal image-reference" href="_images/fmu-qss.png"><img alt="_images/fmu-qss.png" src="_images/fmu-qss.png" style="width: 1069.2px; height: 392.15px;" /></a>
<p class="caption"><span class="caption-number">Fig. 5.3 </span>: Conversion of input signal between FMU-QSS and FMU-ME.</span></p>
</div>
<p>To avoid frequent changes in the input signal, each input signal will have a quantum defined.
The quantum <span class="math">\(\delta q\)</span> will be computed at runtime as</p>
<div class="math">
\[\delta q = \max(\epsilon_{rel} \, |u^-|, \epsilon_{abs}),\]</div>
<p>where <span class="math">\(\epsilon_{rel}\)</span> is the relative tolerance,
<span class="math">\(u^-\)</span> is the last value seen at the input of FMU-ME, and
<span class="math">\(\epsilon_{abs} \triangleq \epsilon_{rel} \, |u_{nom}|\)</span>,
where <span class="math">\(u_{nom}\)</span> is the nominal value of the variable <span class="math">\(u\)</span>.
During initialization, we set <span class="math">\(u^- = u_0\)</span>.
The input signal will be updated only if it has changed by more than a quantum,</p>
<div class="math">
\[|y_s(t) - u^-| \ge \delta q.\]</div>
<p>To parametrize the smooth token, we propose to extend the FMI for model exchange specification to include
<code class="docutils literal"><span class="pre">fmi2SetRealInputDerivatives</span></code> and <code class="docutils literal"><span class="pre">fmi2GetRealOutputDerivatives</span></code>. These two functions exist in the FMI for
co-simulation API.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ul class="last">
<li><p class="first">If a tool can not provide the derivative of an output variable with respect to time,
<code class="docutils literal"><span class="pre">fmi2GetRealOutputDerivatives</span></code> then a master algorithm could approximate
the output derivative as follows:</p>
<ul>
<li><p class="first">If there was no event, then the time derivatives from below and above are equal, and
hence past and current output values can be used, e.g.,</p>
<div class="math">
\[dy/dt \approx \frac{y(t_k)-y(t_{k-1})}{t_k - t_{k-1}}.\]</div>
</li>
<li><p class="first">If there was an event, then the derivative from above need to be approximated.
This could be done by assuming first <span class="math">\(dy/dt =0\)</span> and then building up derivative
information in the next step, or by evaluating the FMU for <span class="math">\(t=t_k+\epsilon\)</span>, where
<span class="math">\(\epsilon\)</span> is a small number, and then computing</p>
<div class="math">
\[dy/dt \approx \frac{y(t_k+\epsilon)-y(t_{k})}{\epsilon}.\]</div>
</li>
</ul>
</li>
<li><p class="first">For FMU-ME, if there is a direct feedthrough, e.g., <span class="math">\(y=f(u)\)</span>,
then <span class="math">\(dy/dt\)</span> cannot be computed, because by the chain rule,</p>
<div class="math">
\[\frac{df(u)}{dt} = \frac{df(u)}{du} \, \frac{du}{dt}\]</div>
<p>but <span class="math">\(du/dt\)</span> is not available in the FMU.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="section" id="summary-of-proposed-changes">
<h3>5.2.2. Summary of Proposed Changes<a class="headerlink" href="#summary-of-proposed-changes" title="Permalink to this headline">¶</a></h3>
<p>Here is a list with a summary of proposed changes</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">fmi2SetReal</span></code> can be called during the continuous, and event time mode for continuous-time states.</li>
<li>The <code class="docutils literal"><span class="pre">&lt;Derivatives&gt;</span></code> element of the model description file will
be extended to include higher order derivatives information.</li>
<li>A new <code class="docutils literal"><span class="pre">&lt;EventIndicators&gt;</span></code> element wil be added to the model description file.
This element will expose event indicators with their <code class="docutils literal"><span class="pre">dependencies</span></code> and time derivatives.</li>
<li>If a model has an event indicator, and the event indicator has a direct
feedthrough on an input variable, then JModelica will exclude the derivatives
of that event indicator from the model description file.</li>
<li>The <code class="docutils literal"><span class="pre">dependencies</span></code> attribute of state derivatives will be extended to include
<code class="docutils literal"><span class="pre">TimeEventHandlers</span></code> on which they depend on. <code class="docutils literal"><span class="pre">TimeEventHandlers</span></code> are variables
which are updated because of a time event.</li>
<li>A new dependency attribute <code class="docutils literal"><span class="pre">ei_dependencies</span></code> will be added to state derivatives listed
in the <code class="docutils literal"><span class="pre">&lt;Derivatives&gt;</span></code> element to include event indicator on which the state derivatives depend on.</li>
<li>A new data structure <code class="docutils literal"><span class="pre">fmi2ExtendedEventInfo</span></code> will be included to provide
additional time event information.</li>
<li>A new function <code class="docutils literal"><span class="pre">fmi2ExtendedNewDiscreteStates</span></code> will be included to retrieve
the <code class="docutils literal"><span class="pre">fmi2ExtendedEventInfo</span></code>.</li>
<li>A new function <code class="docutils literal"><span class="pre">fmi2SetRealInputDerivatives</span></code> will be included to parametrize smooth token.</li>
<li>A new function <code class="docutils literal"><span class="pre">fmi2GetRealOutputDerivatives</span></code> will be included to parametrize smooth token.</li>
</ul>
</div>
<div class="section" id="open-topics">
<h3>5.2.3. Open Topics<a class="headerlink" href="#open-topics" title="Permalink to this headline">¶</a></h3>
<p>This section includes a list of measures which could further improve the efficiency of QSS.
Some of the measures should be implemented and benchmarked to ensure their necessity for QSS.</p>
<div class="section" id="atomic-api">
<h4>5.2.3.1. Atomic API<a class="headerlink" href="#atomic-api" title="Permalink to this headline">¶</a></h4>
<p>A fundamental property of QSS is that variables are advanced at different time rates.
To make this practically efficient with FMUs, an API for individual values and derivatives is essential.</p>
</div>
<div class="section" id="xml-api">
<h4>5.2.3.2. XML/API<a class="headerlink" href="#xml-api" title="Permalink to this headline">¶</a></h4>
<p>All variables with non-constant values probably need to be exposed via the xml
with all their interdependencies. The practicality and benefit of trying
to hide some variables such as algebraic variables by short-circuiting
their dependencies in the xml (or doing this short-circuiting on the QSS side)
should be considered for efficiency reasons.</p>
</div>
<div class="section" id="higher-derivatives">
<h4>5.2.3.3. Higher Derivatives<a class="headerlink" href="#higher-derivatives" title="Permalink to this headline">¶</a></h4>
<p>Numerical differentiation significantly complicates and slows the QSS code:
automatic differentiation provided by the FMU will be a major improvement
and allows practical development of 3rd order QSS solvers.</p>
</div>
<div class="section" id="input-variables">
<h4>5.2.3.4. Input Variables<a class="headerlink" href="#input-variables" title="Permalink to this headline">¶</a></h4>
<div class="admonition-todo admonition" id="index-1">
<p class="first admonition-title">Todo</p>
<p>Stuart wrote &#8220;QSS probably needs input variables limited to deterministic, non-path-dependent functions
since it needs to query their value at possibly forward and backward time steps around the current simulation time.
Is this an issue in ME?&#8221;</p>
<p class="last">I (Thierry) think, this shouldn&#8217;t be a problem for ME FMU.</p>
</div>
</div>
<div class="section" id="annotations">
<h4>5.2.3.5. Annotations<a class="headerlink" href="#annotations" title="Permalink to this headline">¶</a></h4>
<p>Some per-variable annotations that will allow for more efficient solutions by overriding global settings (which are also needed as annotations) include:</p>
<ul class="simple">
<li>Various time steps: <code class="docutils literal"><span class="pre">dt_min</span></code>, <code class="docutils literal"><span class="pre">dt_max</span></code>, <code class="docutils literal"><span class="pre">dt_inf</span></code>, ...</li>
<li>Various flags: QSS method/order (or traditional ODE method for mixed solutions), inflection point requantization, ...</li>
<li>Extra variability flags: constant, linear, quadratic, cubic, variable, ...</li>
</ul>
</div>
<div class="section" id="conditional-expressions-and-event-indicators">
<h4>5.2.3.6. Conditional Expressions and Event Indicators<a class="headerlink" href="#conditional-expressions-and-event-indicators" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>The xml needs to expose the structure of each conditional block:
if or when, sequence order of if/when/else conditionals,
and all the (continuous and discrete/boolean) variables appearing in each conditional.</li>
<li>Non-input boolean/discrete/integer variables should ideally be altered
only by event indicator handlers or <em>time events</em> that are exposed by the FMU
(during loop or by direct query?). Are there other ways that
such variables can change that are only detectable after the fact?
If so, this leaves the QSS with the bad choices of late detection
(due to large time steps) or forcing regular time step value checks on them.</li>
<li>QSS needs non-input boolean/discrete/integer variable dependencies in both directions.</li>
<li>QSS needs the dependencies of conditional expressions on variables appearing in them.</li>
<li>QSS needs the dependencies of variables altered when each conditional fires on the conditional expression variables.</li>
<li>It is not robust for the QSS to try and guess a time point where the FMU will
reliably detect a zero crossing so we need an API to tell the
FMU that a zero crossing occurred at a given time (and maybe with crossing direction information).</li>
<li>If the xml can expose the zero crossing directions of interest that will allow for more efficiency.</li>
</ul>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
  
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
        <br/>
        
      
    </p>
    <p>
        &copy; Copyright (c) All rights reserved.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.1.<br/>
    </p>
  </div>
</footer>

  </body>
</html>